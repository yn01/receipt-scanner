# 要件定義書 — 領収書スキャンWebアプリ（MVP）

## 1. プロジェクト概要

領収書をスマートフォンのカメラで撮影または画像ファイルから読み込み、AIによるOCRで構造化データを抽出・管理するWebアプリケーション。

- **対象ユーザー**: 個人事業主、フリーランス、経費管理を行う個人
- **MVPスコープ**: レシート撮影 → OCR抽出 → データ保存・閲覧の基本フロー
- **コスト目標**: 月額$5以下（月1,000枚処理想定）

---

## 2. 技術スタック（MVP）

| 要素 | 技術 | 理由 |
|------|------|------|
| フロントエンド | Next.js 14 (App Router) + TailwindCSS | API Routes内蔵、Vercelで簡単デプロイ |
| ホスティング | Vercel (Free) | ゼロ設定デプロイ |
| OCR/AI | Claude Haiku Vision API | 最安（$0.0005/枚）、日本語対応、JSON直接抽出 |
| DB | Supabase (PostgreSQL) | 無料枠500MB、RLS対応 |
| 画像ストレージ | Supabase Storage | 無料枠1GB、DB統合でシンプル |
| 認証 | Supabase Auth | JWT + RLS連携、50k MAU無料 |
| 画像前処理 | browser-image-compression | クライアント側で圧縮、転送量・APIコスト削減 |

---

## 3. 機能要件

### FR-01: カメラ撮影 / 画像ファイル読み込み

- プログレッシブエンハンスメント方式で実装する
  - `getUserMedia` 対応ブラウザ: カスタムカメラUI（背面カメラ優先）を表示する
  - 非対応ブラウザ: `<input type="file" accept="image/*" capture="environment">` にフォールバックする
- 画像ファイルの直接選択（ギャラリーからの読み込み）にも対応する
- 受付ファイル形式: JPEG, PNG, WebP, HEIC
- ファイルサイズ上限: 10MB（圧縮前）

### FR-02: 画像前処理

- `browser-image-compression` を使用し、クライアント側で画像を圧縮・リサイズする
  - 最大ファイルサイズ: 1MB
  - 最大解像度: 1920px（長辺）
  - Web Worker使用で UIブロッキングを回避する
- 圧縮後の画像をプレビュー表示する

### FR-03: OCR・構造化データ抽出

- Next.js API Route経由でClaude Haiku Vision APIを呼び出す
- 以下のフィールドを構造化JSONとして抽出する
  - **店名** (`store_name`): 店舗・事業者名
  - **日付** (`date`): 購入日時（ISO 8601形式）
  - **明細** (`items`): 商品名、数量、単価、小計の配列
  - **小計** (`subtotal`): 税抜合計
  - **税額** (`tax`): 消費税額
  - **合計** (`total`): 税込合計金額
  - **支払方法** (`payment_method`): 現金、クレジットカード、電子マネー等
- 抽出結果に信頼度スコア（`confidence`）を含める
- APIエラー時はユーザーにリトライを促すエラーメッセージを表示する

### FR-04: OCR結果の確認・手動編集

- OCR抽出結果をフォーム形式で表示し、ユーザーが確認・修正できるようにする
- 各フィールド（店名、日付、明細、合計等）を個別に編集可能にする
- 明細行の追加・削除を可能にする
- 確認・保存ボタンでデータを確定する
- 元のレシート画像を横に表示し、見比べながら編集できるようにする

### FR-05: レシートデータ一覧表示

- 保存済みレシートを日付降順で一覧表示する
- 各レシートのサムネイル、店名、日付、合計金額を表示する
- 以下の検索・フィルタ機能を提供する
  - キーワード検索（店名、商品名）
  - 日付範囲指定
  - 金額範囲指定
- ページネーションまたは無限スクロールで表示する

### FR-06: レシートデータ詳細表示

- 個別レシートの全データ（店名、日付、明細、合計、税額、支払方法）を表示する
- 元のレシート画像を表示する
- 詳細画面から編集画面へ遷移できるようにする
- レシートの削除機能を提供する

### FR-07: データ永続化（Supabase PostgreSQL）

- レシートデータをSupabase PostgreSQLに保存する
- Row Level Security（RLS）により、ユーザーは自分のデータのみアクセス可能にする
- 論理削除（`deleted_at` カラム）を使用する

### FR-08: 画像保存（Supabase Storage）

- 圧縮済みレシート画像をSupabase Storageに保存する
- ユーザーごとのフォルダ構成（`{user_id}/{receipt_id}.jpg`）で管理する
- Storage側でもRLSポリシーを設定し、自分の画像のみアクセス可能にする

### FR-09: ユーザー認証（Supabase Auth）

- メールアドレス + パスワードによるサインアップ・ログインを実装する
- ログイン状態の維持（JWTトークンベース）
- ログアウト機能
- 未認証ユーザーはログイン画面にリダイレクトする

---

## 4. 非機能要件

### NFR-01: パフォーマンス

| 項目 | 目標値 |
|------|--------|
| 画像圧縮処理 | 2秒以内 |
| 画像アップロード（1MB） | 2秒以内（4G回線想定） |
| OCR処理（API応答） | 3秒以内 |
| レシート一覧表示 | 1秒以内（初回ロード） |
| ページ遷移 | 300ms以内 |

### NFR-02: セキュリティ

- HTTPS必須（Vercelデフォルト対応）
- Claude APIキーはサーバーサイド（API Route）でのみ使用し、クライアントに露出させない
- Supabase RLSによるデータアクセス制御
- 画像アップロード時のファイルタイプ・サイズバリデーション（サーバーサイド）
- XSS対策（Reactのデフォルトエスケープ + 追加サニタイズ）

### NFR-03: コスト制約

- MVP月額運用費: $5以下（月1,000枚処理想定）
  - Vercel: $0（Free枠）
  - Supabase: $0（Free枠）
  - Claude Haiku API: 約$0.50/1,000枚
- API呼び出し回数の監視・アラート機能は Phase 2 で対応

### NFR-04: モバイルファースト

- レスポンシブデザイン（モバイル優先でデザイン）
- タッチ操作に最適化（タップターゲット 44px以上）
- ビューポート設定によるモバイル表示最適化
- カメラ操作はモバイルブラウザでの使用を主に想定

### NFR-05: 対応ブラウザ

| ブラウザ | バージョン |
|---------|-----------|
| Chrome (Android/iOS/Desktop) | 最新2バージョン |
| Safari (iOS/macOS) | 最新2バージョン |
| Firefox (Android/Desktop) | 最新2バージョン |
| Samsung Internet | 最新バージョン |

### NFR-06: アクセシビリティ

- セマンティックHTMLの使用
- フォーム要素へのラベル付与
- キーボード操作対応

---

## 5. 画面一覧

| 画面ID | 画面名 | パス | 概要 |
|--------|--------|------|------|
| S-01 | ログイン | `/login` | メール・パスワード入力、サインアップリンク |
| S-02 | サインアップ | `/signup` | 新規ユーザー登録 |
| S-03 | レシート一覧 | `/` (ホーム) | 保存済みレシート一覧、検索・フィルタ |
| S-04 | レシート撮影・読込 | `/scan` | カメラ撮影 or ファイル選択、画像プレビュー |
| S-05 | OCR結果確認・編集 | `/scan/confirm` | 抽出データの確認・修正フォーム |
| S-06 | レシート詳細 | `/receipts/[id]` | 個別レシートの全情報表示 |
| S-07 | レシート編集 | `/receipts/[id]/edit` | 保存済みレシートの編集 |

### 画面遷移フロー

```
S-01 ログイン → S-03 一覧（認証後）
S-02 サインアップ → S-03 一覧（登録後）

S-03 一覧 → S-04 撮影・読込（FABボタン）
S-04 撮影・読込 → S-05 OCR結果確認（撮影/選択後）
S-05 OCR結果確認 → S-03 一覧（保存後）

S-03 一覧 → S-06 詳細（レシートタップ）
S-06 詳細 → S-07 編集（編集ボタン）
S-07 編集 → S-06 詳細（保存後）
```

---

## 6. データモデル

### receipts テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| `id` | uuid (PK) | レシートID |
| `user_id` | uuid (FK → auth.users) | ユーザーID |
| `store_name` | text | 店名 |
| `date` | date | 購入日 |
| `subtotal` | integer | 小計（税抜、円単位） |
| `tax` | integer | 税額（円単位） |
| `total` | integer | 合計（税込、円単位） |
| `payment_method` | text | 支払方法 |
| `image_url` | text | Supabase Storage上の画像パス |
| `ocr_confidence` | real | OCR信頼度スコア (0.0-1.0) |
| `ocr_raw_response` | jsonb | OCR生レスポンス（デバッグ用） |
| `created_at` | timestamptz | 作成日時 |
| `updated_at` | timestamptz | 更新日時 |
| `deleted_at` | timestamptz | 論理削除日時 |

### receipt_items テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| `id` | uuid (PK) | 明細ID |
| `receipt_id` | uuid (FK → receipts) | レシートID |
| `name` | text | 商品名 |
| `quantity` | integer | 数量 |
| `unit_price` | integer | 単価（円単位） |
| `subtotal` | integer | 小計（円単位） |
| `sort_order` | integer | 表示順 |

### RLSポリシー

- `receipts`: `user_id = auth.uid()` で全操作を制限
- `receipt_items`: `receipt_id` が自ユーザーの `receipts` に属するもののみアクセス可能
- Supabase Storage: `{user_id}/` プレフィックスのオブジェクトのみアクセス可能

---

## 7. 外部API連携

### Claude Haiku Vision API

| 項目 | 内容 |
|------|------|
| エンドポイント | `https://api.anthropic.com/v1/messages` |
| 認証 | `x-api-key` ヘッダー（サーバーサイドのみ） |
| モデル | `claude-haiku-4-5-20251001`（または最新Haikuモデル） |
| 入力 | Base64エンコード画像 + 構造化抽出プロンプト |
| 出力 | JSON形式の構造化レシートデータ |
| コスト | 約$0.0005/画像 |
| レート制限 | Tier 1: 60 RPM |
| タイムアウト | 10秒（リトライ1回） |

### Supabase

| 項目 | 内容 |
|------|------|
| Database | PostgreSQL（無料枠500MB） |
| Storage | オブジェクトストレージ（無料枠1GB） |
| Auth | JWT認証（無料枠50k MAU） |
| クライアントSDK | `@supabase/supabase-js` |
| 接続方式 | クライアントSDK（REST API経由） |

---

## 8. MVPスコープ外（Phase 2以降）

以下の機能はMVPには含めず、Phase 2以降で対応する。

- CSV/PDFエクスポート
- カテゴリ分類・タグ付け
- 月次レポート・グラフ表示
- 複数レシートの一括撮影
- PWA対応（オフライン、ホーム画面追加）
- カメラガイドオーバーレイ（枠表示）
- エッジ検出・台形補正（OpenCV.js）
- OCR精度向上のためのフォールバック（Azure Document Intelligence）
- ソーシャルログイン（Google, Apple）
- API呼び出し回数の監視・アラート
- Claude Sonnetへのアップグレード（高精度モード）
